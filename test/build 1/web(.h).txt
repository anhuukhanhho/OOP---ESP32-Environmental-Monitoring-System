#ifndef WEB_H
#define WEB_H

#include <WebServer.h>
#include <Adafruit_BME280.h>
#include <PMS.h>
#include <TinyGPSPlus.h>

// External objects
extern WebServer server;
extern Adafruit_BME280 bme;
extern PMS pms;
extern PMS::DATA pmsData;
extern TinyGPSPlus gps;

// Function declarations
// ===== Web Page =====
String webpage() {
  String html = "<!DOCTYPE html><html><head>";
  html += "<meta charset='utf-8'>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1'>";
  html += "<meta http-equiv='refresh' content='4'>";  // Auto refresh the website every 4 seconds
  html += "<style>";
  html += "body{font-family:Arial;text-align:center;background:#f2f2f2;font-size:14px;}";
  html += "h1{color:#333;}";
  html += ".box{background:#fff;padding:10px 10px 20px 10px;margin:10px;border-radius:15px;}";
  html += "</style></head><body>";

  html += "<h1>ESP32 Environmental Station</h1>";

  html += "<div class='box'><h2>BME280 General Data</h2>";
  html += "Temperature: " + String(bme.readTemperature()) + " *C<br>";
  html += "Humidity: " + String(bme.readHumidity()) + " %<br>";
  html += "Pressure: " + String(bme.readPressure() / 100.0F) + " hPa<br>";
  html += "</div>";

  html += "<h2>PMS7003 Air Quality Data</h2>";
  html += "<p>Unit of measurement:<br>microgram per cubic meter (ug/m^3)</p>";
  html += "PM1.0: " + String(pmsData.PM_AE_UG_1_0) + " ug/m^3<br>";
  html += "PM2.5: " + String(pmsData.PM_AE_UG_2_5) + " ug/m^3<br>";
  html += "PM10: " + String(pmsData.PM_AE_UG_10_0) + " ug/m^3<br>";

  html += "<div class='box'><h2>GPS (NEO-M8N) Locator</h2>";
  if (gps.location.isValid()) {
    html += "Latitude: " + String(gps.location.lat(), 6) + "<br>";
    html += "Longitude: " + String(gps.location.lng(), 6) + "<br>";
  } else {
    html += "Waiting for GPS fix...<br>";
  }
  html += "Satellites: " + String(gps.satellites.value()) + "<br>";
  html += "</div>";

  html += "</body></html>";
  return html;
}

// ===== Web Handler =====
void handleRoot() {
  server.send(200, "text/html", webpage());
}

#endif
